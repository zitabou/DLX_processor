#!/bin/bash

# ===================================================================
# Check the number of arguments passed by command line
# ===================================================================

if [ "$#" -ne 1 ]; then
    echo $''
    echo "Illegal number of arguments!"
    echo "Usage: $0 <dlx_assembly_file>.asm"
    echo $''
	exit 1
fi

# ===================================================================
# Get filename with no extension
# ===================================================================

asmfile=`echo $1 | sed s/[.].*//g`

# ===================================================================
# Delete old compiled files
# ===================================================================

rm -f *.bin
rm -f *.test
rm -f *.list
rm -f $asmfile_dump.txt

# ===================================================================
# Compile the current .asm file
# ===================================================================

perl dlxasm.pl -o $asmfile.bin -list $asmfile.list $1

# ===================================================================
# Delete non necessary post compiled files
# ===================================================================

rm *.bin.hdr

# ===================================================================
# Create the dump file
# ===================================================================

cat $asmfile.bin | hexdump -v -e '/1 "%02X" /1 "%02X" /1 "%02X" /1 "%02X\n"' > $asmfile\_dump.txt

# ===================================================================
# Create the VHDL control unit readable version
# ===================================================================

./conv2memory $asmfile.bin > ../iram.mem

